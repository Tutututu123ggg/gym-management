// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum Role {
  ADMIN
  TRAINER
  STAFF
  MEMBER
}

enum ScheduleType {
  WITH_TRAINER
  SELF_PRACTICE
}

enum PlanCategory {
  GYM
  CLASS
  POOL
}

enum InvoiceStatus {
  PENDING
  PAID
  CANCELLED
  OVERDUE
}

enum EquipmentStatus {
  GOOD
  MAINTENANCE
  BROKEN
}

enum BookingStatus {
  BOOKED
  CHECKED_IN
  CANCELLED
  NO_SHOW
}

// --- MODELS ---

// 1. User
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  password      String
  role          Role      @default(MEMBER)
  
  // Ph√¢n lo·∫°i ph√≤ng ban
  department    String?   

  phone         String?
  address       String?
  bio           String?
  avatar        String?
  gender        String?
  dateOfBirth   DateTime?

  // Stats
  totalHours    Float     @default(0)
  totalCheckIns Int       @default(0)
  currentStreak Int       @default(0)
  lastCheckIn   DateTime?

  // Relations
  checkIns      CheckIn[]
  schedules     WorkoutSchedule[]
  bodyMetrics   BodyMetric[]
  subscriptions Subscription[]
  paymentMethods PaymentMethod[]
  invoices      Invoice[]
  feedbacks     Feedback[]
  staffKPIs     StaffKPI[]
  
  // Quan h·ªá cho t√≠nh nƒÉng L·ªãch h·ªçc
  taughtClasses ClassSession[] @relation("TrainerClasses")
  bookings      Booking[]      

  emailVerified     DateTime?
  verificationToken String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  announcements       Announcement[]
  staffNotes          StaffNote[]
}

// 2. Check-in
model CheckIn {
  id         String    @id @default(uuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id])
  checkInAt  DateTime  @default(now())
  checkOutAt DateTime?
}

// 3. Plan (G√≥i b√°n - Level 1)
model Plan {
  id           String        @id @default(uuid())
  name         String        
  price        Float
  unit         String        
  desc         String?
  isActive     Boolean       @default(true)
  category     PlanCategory  @default(GYM)
  durationDays Int           @default(30)

  // üëá [KH√îI PH·ª§C] C√°c tr∆∞·ªùng c≈© ƒë·ªÉ tr√°nh m·∫•t d·ªØ li·ªáu
  features     String[]      
  highlight    Boolean       @default(false)
  image        String?
  tag          String?

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  subscriptions Subscription[]
  promotions    Promotion[]
  gymClasses    GymClass[]    
}

// 4. GymClass (L·ªõp m√¥n - Level 2)
model GymClass {
  id          String   @id @default(uuid())
  name        String   
  description String?
  
  planId      String
  plan        Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  sessions    ClassSession[] 

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
}

// 5. Subscription
model Subscription {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  planId    String
  plan      Plan      @relation(fields: [planId], references: [id])

  startDate DateTime  @default(now())
  endDate   DateTime
  isActive  Boolean   @default(true)
  autoRenew Boolean   @default(true)

  invoices  Invoice[]
}

// 6. Invoice
model Invoice {
  id             String        @id @default(uuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  subscriptionId String
  subscription   Subscription  @relation(fields: [subscriptionId], references: [id])

  amount         Float
  status         InvoiceStatus @default(PENDING)
  dueDate        DateTime
  paidAt         DateTime?
  createdAt      DateTime      @default(now())
}

// 7. PaymentMethod
model PaymentMethod {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])

  cardLast4  String
  cardBrand  String
  holderName String
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
}

// 8. WorkoutSchedule
model WorkoutSchedule {
  id          String       @id @default(uuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  title       String
  date        DateTime
  type        ScheduleType @default(SELF_PRACTICE)
  trainerName String?
  isCompleted Boolean      @default(false)
  createdAt   DateTime     @default(now())
}

// 9. BodyMetric
model BodyMetric {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  height     Float
  weight     Float
  bmi        Float
  recordedAt DateTime @default(now())
}

// 10. Feedback
model Feedback {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  title     String
  message   String
  reply     String?
  status    String   @default("PENDING")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 11. Room
model Room {
  id            String              @id @default(uuid())
  name          String
  categories    EquipmentCategory[]
  classSessions ClassSession[] 
}

// 12. EquipmentCategory
model EquipmentCategory {
  id     String      @id @default(uuid())
  name   String
  roomId String
  room   Room        @relation(fields: [roomId], references: [id])
  items  Equipment[]
}

// 13. Equipment
model Equipment {
  id             String          @id @default(uuid())
  code           String          
  name           String?         
  image          String?
  status         EquipmentStatus @default(GOOD)
  lastMaintained DateTime?
  categoryId     String
  category       EquipmentCategory @relation(fields: [categoryId], references: [id])
  description    String?   
  origin         String?   
  purchaseDate   DateTime? 
}

// 14. Staff KPI
model StaffKPI {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  month     DateTime 
  kpiScore  Float    
  sessions  Int      
  notes     String?
  bonus     Float    @default(0) // L∆∞u ti·ªÅn th∆∞·ªüng (VND)
  @@unique([userId, month])
}

// 15. Promotion
model Promotion {
  id          String    @id @default(uuid())
  name        String    
  salePrice   Float     
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean   @default(true)

  planId      String
  plan        Plan      @relation(fields: [planId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
}

// 16. ClassSession (Bu·ªïi h·ªçc tr√™n l·ªãch - Level 3)
model ClassSession {
  id          String   @id @default(uuid())
  
  gymClassId  String
  gymClass    GymClass @relation(fields: [gymClassId], references: [id], onDelete: Cascade)

  trainerId   String?
  trainer     User?    @relation("TrainerClasses", fields: [trainerId], references: [id])

  roomId      String?
  room        Room?    @relation(fields: [roomId], references: [id])

  startTime   DateTime
  endTime     DateTime
  maxCapacity Int      @default(20)
  isCanceled  Boolean  @default(false)

  createdAt   DateTime @default(now())
  bookings    Booking[]
}

// 17. Booking (ƒê·∫∑t ch·ªó)
model Booking {
  id             String        @id @default(uuid())
  
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  
  classSessionId String
  classSession   ClassSession  @relation(fields: [classSessionId], references: [id])

  status         BookingStatus @default(BOOKED) 
  bookedAt       DateTime      @default(now())

  @@unique([userId, classSessionId]) 
}

// --- ENUM M·ªöI ---
enum TaskFrequency {
  ONCE      // L√†m 1 l·∫ßn r·ªìi th√¥i
  DAILY     // L·∫∑p l·∫°i h√†ng ng√†y
  WEEKLY    // L·∫∑p l·∫°i h√†ng tu·∫ßn
  MONTHLY   // L·∫∑p l·∫°i h√†ng th√°ng
}

// --- MODELS M·ªöI ---

// 18. Announcement (Th√¥ng b√°o t·ª´ Admin)
model Announcement {
  id        String   @id @default(uuid())
  title     String
  content   String
  isActive  Boolean  @default(true) // visible/invisible
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Ng∆∞·ªùi t·∫°o (Admin n√†o vi·∫øt)
  authorId  String?
  author    User?    @relation(fields: [authorId], references: [id])
}

// 19. StaffNote (Ghi ch√∫/Task c√° nh√¢n c·ªßa nh√¢n vi√™n)
model StaffNote {
  id        String        @id @default(uuid())
  content   String
  isDone    Boolean       @default(false)
  frequency TaskFrequency @default(ONCE)
  
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}